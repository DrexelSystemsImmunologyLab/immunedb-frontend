<script type="text/ng-template" id="mutationsModal.html">
  <div class="modal-header">
      <h4 class="modal-title">{{ title }}</h4>
  </div>
  <div class="modal-body">
    <table class="table">
      <thead>
        <tr class="active">
          <th>Count</th>
          <th>Position</th>
          <th>NT Mutation</th>
          <th>AA Mutation</th>
        </tr>
      </thead>
      <tbody ng-repeat="type in ['synonymous', 'conservative', 'nonconservative']" ng-show="data.mutations[type].length > 0">
        <tr class="info">
          <td colspan="4"><strong>{{ type | capitalize }}</strong></td>
        </tr>
        <tr ng-repeat="mut in data.mutations[type] | orderBy:'position'">
          <td>{{ mut.count }}</td>
          <td>{{ mut.position }}</td>
          <td><strong ng-bind-html="mut.from | dna"></strong> to <strong ng-bind-html="mut.to | dna"></strong></td>
          <td><strong ng-bind-html="mut.aa_from | aminoAcid"></strong> to <strong ng-bind-html="mut.aa_to | aminoAcid"></strong></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" ng-click="dismiss()">Dismiss</button>
  </div>
</script>
<div class="header">
  <ol class="breadcrumb">
    <li><a href="#/{{ api_path }}/clones"><i class="fa fa-sitemap fa-fw"></i>Clones</a> </li>
    <li>Clone Comparison</li>
  </ol>
</div>
<div class='notifications top-right'></div>
<button type="button" class="btn btn-success pull-right"
    ng-click="addPin()">
  <i class="fa fa-thumb-tack fa-fw"></i> Pin Page
</button>

<div class="alert alert-danger" role="alert" ng-show="apiChanged">
<strong>Warning: </strong><p>This information may be incorrect since clone
identification is not be consistent across.</p> <p>Please use the
clone group IDs to compare similar clones across versions.</p></div>

<h3>Mutation Analysis</h3>
<div class="table-responsive">
  <table class="table table-bordered" ng-repeat="info in cloneInfo">
    <thead>
      <tr class="active">
        <th>Clone ID</th>
        <th>Group ID</th>
        <th>V Gene</th>
        <th>J Gene</th>
        <th>CDR3 Length</th>
        <th>CDR3 AA</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ info.clone.id }}</td>
        <td><a href="#/{{ api_path }}/clones/?group={{ info.clone.group.id }}"
          target="_blank">{{ info.clone.group.id }}</a></td>
        <td>{{ info.clone.group.v_gene }}</td>
        <td>{{ info.clone.group.j_gene }}</td>
        <td>{{ info.clone.cdr3_nt.length }}</td>
        <td ng-bind-html="info.clone.group.cdr3_aa | aminoAcid" class="text-mono"></td>
      </tr>
      <tr>
        <td colspan="6">
          <h4 class="faded text-center" ng-hide="showSeqs">Hid {{ info.seqs.length }} sequences for brevity.  Click <a ng-click="showSeqs = !showSeqs">here</a> to show.</h4>
          <h4 ng-show="showSeqs">Sequences (<a ng-click="showSeqs = !showSeqs">Hide</a>)</h4>
          <table class="table table-bordered" ng-show="showSeqs">
            <thead>
              <tr class="info">
                <th>Sample #</th>
                <th>Sample Name</th>
                <th>Sequence ID</th>
                <th>Copy Number</th>
              </tr>
            </thead>
            <tbody ng-repeat="stat in info.seqs">
              <tr>
                <td>{{ stat.sample.id }}</td>
                <td><a href="#/{{ api_path }}/samples/{{ stat.sample.id }}" target="_blank">{{ stat.sample.name }}</a></td>
                <td><a href="#/{{ api_path }}/sequence/{{stat.sample.id}}/{{ stat.seq_id }}" target="_blank">{{ stat.seq_id }}</a></td>
                <td>{{ stat.copy_number }}</td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
      <tr>
        <td colspan="6" ng-init="field='unique'">
          <h4>
            {{ field == 'total' ? 'Total' : 'Unique' }} Mutations
            <button ng-click="field = (field == 'unique' ? 'total' : 'unique')" class="btn btn-primary btn-align">
              Switch to {{ field == 'total' ? 'Unique' : 'Total' }} Mutations
            </button>
            <div class="btn-group btn-align" style="float:right">
              <button type="button" class="btn btn-default btn-info dropdown-toggle" data-toggle="dropdown">
                Export FASTA...<span class="caret"></span>
              </button>
              <ul class="dropdown-menu pull-right" role="menu">
                <li><a href="{{ api }}data/sequences/fasta/false/{{ info.clone.id }}/{{ params }}" target="_blank">Original sequences</a></li>
                <li><a href="{{ api }}data/sequences/fasta/true/{{ info.clone.id }}/{{ params }}" target="_blank">Fill in germline</a></li>
              </ul>
            </div>
          </h4>
          <table class="table table-bordered">
            <thead>
              <tr class="info">
                <th>Region</th>
                <th>Synonymous</th>
                <th>Non-Synonymous</th>
                <th>Conservative</th>
                <th>Non-Conservative</th>
              </tr>
            </thead>
            <tbody ng-repeat="(region, stat) in info.mutation_stats.regions">
              <tr>
                <td>
                  <strong>{{ region | uppercase }}</strong>
                  <button ng-disabled="stat.counts[field].synonymous + stat.counts[field].nonconservative + stat.counts[field].conservative == 0" class="btn btn-default btn-xs"
                  ng-click="openModal('Mutations', stat)">Show Mutations</button>
                </td>
                <td>
                  {{ stat.counts[field].synonymous }}
                  <span class="faded">({{
                    100 * stat.counts[field].synonymous /
                    (stat.counts[field].nonconservative +
                    stat.counts[field].conservative +
                    stat.counts[field].synonymous) | orZero | number:2 }}%)</span>
                </td>
                <td>
                  {{ stat.counts[field].nonconservative + stat.counts[field].conservative }}
                  <span class="faded">({{
                    100 * (stat.counts[field].nonconservative + stat.counts[field].conservative) /
                    (stat.counts[field].nonconservative +
                    stat.counts[field].conservative +
                    stat.counts[field].synonymous) | orZero | number:2 }}%)</span>
                </td>
                <td class="active">
                  {{ stat.counts[field].conservative }}
                  <span class="faded">({{ 100 * stat.counts[field].conservative / (stat.counts[field].nonconservative + stat.counts[field].conservative) | orZero | number:2 }}%)</span>
                </td>
                <td class="active">
                  {{ stat.counts[field].nonconservative }}
                  <span class="faded">({{ 100 * stat.counts[field].nonconservative / (stat.counts[field].nonconservative + stat.counts[field].conservative) | orZero | number:2 }}%)</span>
                </td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
      <tr>
        <td colspan="6">
            <h4>Lineage Tree</h4>
            <div id="tree_{{ info.clone.id }}"></div>
        </td>
      </tr>
      <tr>
        <td colspan="6">
          <h4 class="faded text-center" ng-hide="showComp">Comparison hidden for brevity.  Click <a ng-click="showComp = !showComp">here</a> to show.</h4>
          <h4 ng-show="showComp">Sequence Comparison (<a ng-click="showComp = !showComp">Hide</a>)</h4>
          <div ng-show="showComp">
            <div class="slideWrap">
              <span class="scroller">
                <canvas id="compare-{{ info.clone.id }}">
                Your browser doesn't support HTML5! Please download a newer
                browser.
                </canvas>
              </span>
            </div>
            <ul class="pager">
              <li ng-show="pages[info.clone.id] > 0"><a href="" ng-click="prevPage(info.clone.id)">Previous</a></li>
              <li>Page {{ pages[info.clone.id] + 1 }} / {{
                ceil(info.seqs.length / SEQS_PER_CANVAS) }}</li>
              <li
                ng-show="pages[info.clone.id] + 1 < ceil(info.seqs.length /
              SEQS_PER_CANVAS)"><a href="" ng-click="nextPage(info.clone.id)">Next</a></li>
            </ul>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
